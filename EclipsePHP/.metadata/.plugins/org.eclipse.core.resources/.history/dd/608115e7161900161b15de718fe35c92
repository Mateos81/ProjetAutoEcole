<?php
/**
 * Projet 2ème Année 3iL
 * @author CIULLI - MATEOS - ROUX
 * @version 1.0
 * @package DAL
 */

include __DIR__ . "/../BLL/Outils.php";
 
 /**
  * Classe d'accès aux données pour la classe Salarie.
  * DAL pour Data Access Layer.
  */
class DAL_Salarie {
	
	/**
	 * Création d'un nouveau salarié.
	 * @param string $nom Le nom du nouveau salarié.
	 * @param string $prenom Le prénom du nouveau salarié.
	 * @param string $surnom Le surnom du nouveau salarié.
	 * @param string $adr L'adresse du nouveau salarié.
	 * @param string $ville La ville du nouveau salarié.
	 * @param string $cp Le code postal du nouveau salarié.
	 * @param string $tel Le numéro de téléphone du nouveau salarié.
	 * @param int $vehicule Le numéro du véhicule du nouveau salarié.
	 * @param int $poste Le poste du nouveau salarié.
	 * @return int Le numéro unique en base identifiant le salarié.
	 */
	public static function creerSalarie(
			string $nom,
			string $prenom,
			string $surnom,
			string $adr,
			string $ville,
			string $cp,
			string $tel,
			int $vehicule,
			int $poste) {
		$conn = Outils::connexion_base();
		
		// Construction de la commande d'accès à la procédure PL/SQL
		$cmd = 'BEGIN :resultat := ajoutSalarie(';
		$cmd .= ':nom, :prenom, :surnom, :adr, :ville, :cp, ';
		$cmd .= ':tel, :vehicule, :poste); END;';
		 
		$stid = oci_parse($conn, $cmd);
		
		oci_bind_by_name($stid, ':resultat', $resultat);
		
		oci_bind_by_name($stid, ':nom', $nom);
		oci_bind_by_name($stid, ':prenom', $prenom);
		oci_bind_by_name($stid, ':surnom', $surnom);
		oci_bind_by_name($stid, ':adr', $adr);
		oci_bind_by_name($stid, ':ville', $ville);
		oci_bind_by_name($stid, ':cp', $cp);
		oci_bind_by_name($stid, ':tel', $tel);
		oci_bind_by_name($stid, ':vehicule', $vehicule);
		oci_bind_by_name($stid, ':poste', $poste);
		
		oci_execute($stid);
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
		
		return $resultat;
	}
	
/**
	 * Mise à jour d'un salarié existant.
	 * @param int $id L'identifiant du salarié.
	 * @param string $nom Le nom du salarié.
	 * @param string $prenom Le prénom du salarié.
	 * @param string $surnom Le surnom du salarié.
	 * @param string $adr L'adresse du salarié.
	 * @param string $ville La ville du salarié.
	 * @param string $cp Le code postal du salarié.
	 * @param string $tel Le numéro de téléphone du salarié.
	 * @param int $vehicule Le numéro du véhicule du salarié.
	 * @param int $poste Le poste du salarié.
	 */
	public static function modifierSalarie(
			int $id,
			string $nom,
			string $prenom,
			string $surnom,
			string $adr,
			string $ville,
			string $cp,
			string $tel,
			int $vehicule,
			int $poste) {
		$conn = Outils::connexion_base();
		
		// Construction de la commande d'accès à la procédure PL/SQL
		$cmd = 'BEGIN modifSalarie(';
		$cmd .= ':nom, :prenom, :surnom, :adr, :ville, :cp, ';
		$cmd .= ':tel, :vehicule, :poste); END;';
		 
		$stid = oci_parse($conn, $cmd);
		
		oci_bind_by_name($stid, ':nom', $nom);
		oci_bind_by_name($stid, ':prenom', $prenom);
		oci_bind_by_name($stid, ':surnom', $surnom);
		oci_bind_by_name($stid, ':adr', $adr);
		oci_bind_by_name($stid, ':ville', $ville);
		oci_bind_by_name($stid, ':cp', $cp);
		oci_bind_by_name($stid, ':tel', $tel);
		oci_bind_by_name($stid, ':vehicule', $vehicule);
		oci_bind_by_name($stid, ':poste', $poste);
		
		oci_execute($stid);
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
	}
	
	/**
	 * Suppression d'un salarié.
	 * @param int $id Identifiant unique du salarié à supprimer.
	 */
	public static function suppressionSalarie(int $id) {
		$conn = Outils::connexion_base();
		 
		$stid = oci_parse($conn, 'BEGIN suppressionSalarie(:id); END;');
		oci_bind_by_name($stid, ':id', $id);
		
		oci_execute($stid);
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
	}
	
	/**
	 * Récupère et renvoie les informations du salarié via son surnom.
	 * @param string $surnom Le surnom du salarié recherché.
	 * @return array Un tableau à une ligne
	 * 				 contenant les informations du salarié recherché.
	 */
	public static function getSalarieBySurnom($surnom) {
		$conn = Outils::connexion_base();
		
		$req = 'SELECT * FROM SALARIE ';
		$req .= 'WHERE salarie_surnom LIKE %' . $surnom . '%';
			
		$stid =	oci_parse($conn, $req);
		oci_execute($stid);
		
		$tab = array();
		while ($row = oci_fetch_array($stid, OCI_ASSOC+OCI_RETURN_NULLS)) {
			$tab[] = $row;
		}
		
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
		
		return $tab;
	}
	
	/**
	 * Liste les élèves d'un salarié.
	 * @param int $id Identifiant d'un salarié.
	 * @return array La liste des élèves.
	 */
	public static function listeEleves($id) {
	    $conn = Outils::connexion_base();
			
		$stid =
			oci_parse(
				$conn,
				'SELECT * FROM ELEVE WHERE eleve_salarie = ' . $id);
		oci_execute($stid);
		
		$tab = array();
		while ($row = oci_fetch_array($stid, OCI_ASSOC+OCI_RETURN_NULLS)) {
			$tab[] = $row;
		}
		
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
		
		return $tab;
	}
	
	/**
	 * Liste les leçons d'un salarié.
	 * @param int $id Identifiant d'un salarié.
	 * @return array La liste des leçons.
	 */
	public static function listeLecons($id) {
	    $conn = Outils::connexion_base();
			
		$stid =
			oci_parse(
				$conn,
				'SELECT * FROM LECON WHERE lecon_salarie = ' . $id);
		oci_execute($stid);
		
		$tab = array();
		while ($row = oci_fetch_array($stid, OCI_ASSOC+OCI_RETURN_NULLS)) {
			$tab[] = $row;
		}
		
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
		
		return $tab;
	}
	
	/**
	 * Liste les salariés.
	 * @return array La liste des salariés.
	 */
	public static function listeSalaries() {
	    $conn = Outils::connexion_base();
			
		$stid =
			oci_parse(
				$conn,
				'SELECT * FROM SALARIE');
		oci_execute($stid);
		
		$tab = array();
		while ($row = oci_fetch_array($stid, OCI_ASSOC+OCI_RETURN_NULLS)) {
			$tab[] = $row;
		}
		
		oci_free_statement($stid);
		
		Outils.deconnexion_base($conn);
		
		return $tab;
	}
}
?>
